<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>GISè€ƒç ”é™¢æ ¡åœ°å›¾</title>
    <style>
        html, body { 
            margin: 0;
            padding: 0;
            height: 100%;
        }
        .container {
            display: flex;
            height: 100%;
        }
        #map {
            flex: 1;
            position: relative;
        }
        .sidebar {
            width: 300px;
            background: #f8f8f8;
            padding: 20px;
            overflow-y: auto;
        }
        .school-info-panel {
            position: absolute;
            top: 80px;
            left: 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 600px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            display: none;
        }
        .province-group {
            margin-bottom: 10px;
        }
        .province-header {
            background: #eee;
            padding: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .province-header.active .arrow {
            transform: rotate(180deg);
        }
        .province-schools {
            display: none;
            padding: 8px 0;
        }
        .province-schools.active {
            display: block;
        }
        .school-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .school-item:hover {
            background: #f0f0f0;
        }
        .school-item small {
            color: #666;
            display: block;
            margin-top: 4px;
        }
        .map-controls {
            position: absolute;
            right: 10px;
            bottom: 10px;
            z-index: 1000;
            display: flex;
            gap: 5px;
            flex-direction: column;
        }
        .map-control-group {
            display: flex;
            gap: 5px;
        }
        .map-control-button {
            width: 32px;
            height: 32px;
            background: white;
            border: none;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #333;
        }
        .map-control-button.active {
            background: #4a89dc;
            color: white;
        }
        .map-control-button:hover {
            background: #f0f0f0;
        }
        .map-control-button.active:hover {
            background: #357abd;
        }
        .search-box {
            margin-bottom: 20px;
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .search-input:focus {
            outline: none;
            border-color: #4a89dc;
            box-shadow: 0 0 0 2px rgba(74, 137, 220, 0.2);
        }
        .search-clear {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #999;
            font-size: 18px;
            display: none;
        }
        .search-clear:hover {
            color: #666;
        }
        .favorite-tab {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        .tab-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #eee;
            cursor: pointer;
            flex: 1;
        }
        .tab-button.active {
            background: #4a89dc;
            color: white;
        }
        .rating-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .rating-items-container {
            display: flex;
            gap: 20px;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .rating-item {
            flex: 1;
            text-align: center;
        }
        .rating-item label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-size: 13px;
        }
        .rating-stars {
            display: flex;
            gap: 3px;
            justify-content: center;
        }
        .star {
            cursor: pointer;
            font-size: 18px;
            color: #ddd;
        }
        .star.active {
            color: #ffd700;
        }
        .favorite-button {
            margin-top: 10px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #4a89dc;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .favorite-button.favorited {
            background: #dc4a4a;
        }
        .favorite-button:hover {
            opacity: 0.9;
        }
        .view-switch {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .view-switch-button {
            padding: 6px 12px;
            border: 1px solid #4a89dc;
            border-radius: 4px;
            background: white;
            color: #4a89dc;
            cursor: pointer;
            font-size: 13px;
        }
        .view-switch-button.active {
            background: #4a89dc;
            color: white;
        }
        .tier-group {
            margin-bottom: 10px;
        }
        .tier-header {
            background: #4a89dc;
            color: white;
            padding: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
        }
        .tier-header .arrow {
            color: white;
        }
        .tier-schools {
            display: none;
            padding: 8px 0;
        }
        .tier-schools.active {
            display: block;
        }
        .site-logo {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .site-logo img {
            width: 24px;
            height: 24px;
        }
    </style>
    <script>
        window._AMapSecurityConfig = {
            securityJsCode: '35baddcb7a438e2e024fb75d1025068a'
        }
    </script>
    <script src="https://webapi.amap.com/maps?v=2.0&key=35baddcb7a438e2e024fb75d1025068a&plugin=AMap.HeatMap"></script>
</head>
<body>
    <div class="container">
        <div id="map">
            <div class="site-logo">
                <img src="data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Ccircle cx='12' cy='12' r='10' fill='%234a89dc'/%3E%3Cpath d='M12 6l4 4-4 4-4-4 4-4zM8 14l4 4 4-4-4 4-4-4z' fill='white'/%3E%3C/svg%3E" alt="logo">
                GISè€ƒç ”é™¢æ ¡å¯è§†åŒ–ä¸“é¢˜å›¾
            </div>
            <div id="schoolInfo" class="school-info-panel"></div>
            <div class="map-controls">
                <div class="map-control-group">
                    <button class="map-control-button" id="satelliteToggle" title="åˆ‡æ¢å«æ˜Ÿå›¾">ğŸ›°ï¸</button>
                    <button class="map-control-button" id="heatmapToggle" title="åˆ‡æ¢çƒ­åŠ›å›¾">ğŸŒ¡ï¸</button>
                </div>
                <div class="map-control-group">
                    <button class="map-control-button" id="zoomIn" title="æ”¾å¤§">+</button>
                    <button class="map-control-button" id="zoomOut" title="ç¼©å°">-</button>
                    <button class="map-control-button" id="zoomFit" title="ç¼©æ”¾è‡³å…¨å›½èŒƒå›´">âŸ²</button>
                </div>
            </div>
        </div>
        <div class="sidebar">
            <h2>GISè€ƒç ”é™¢æ ¡åˆ—è¡¨</h2>
            <div class="favorite-tab">
                <button class="tab-button active" id="allSchools">æ‰€æœ‰é™¢æ ¡</button>
                <button class="tab-button" id="favorites">æˆ‘çš„æ”¶è—</button>
            </div>
            <div class="view-switch">
                <button class="view-switch-button active" id="viewByProvince">æŒ‰çœä»½æŸ¥çœ‹</button>
                <button class="view-switch-button" id="viewByTier">æŒ‰å±‚çº§æŸ¥çœ‹</button>
                <button class="view-switch-button" id="clearFavorites" style="display: none; font-size: 12px; padding: 4px 8px; background-color: #e74c3c; color: white;">æ¸…ç©ºæ”¶è—</button>
            </div>
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢é™¢æ ¡åç§°...">
                <span class="search-clear" id="searchClear">Ã—</span>
            </div>
            <div id="schoolList"></div>
        </div>
    </div>

    <script>
        let map;
        let schools = [];
        let favorites = JSON.parse(localStorage.getItem('favorites') || '{}');
        let currentView = 'province'; // 'province' or 'tier'
        let satelliteLayer;
        let heatmap;
        let isHeatmapVisible = false;
        let isSatelliteVisible = false;
        let currentMarker = null; // è·Ÿè¸ªå½“å‰é€‰ä¸­çš„æ ‡è®°
        let currentHighlightedMarker = null; // æ·»åŠ å…¨å±€å˜é‡ç”¨äºè·Ÿè¸ªå½“å‰é«˜äº®çš„æ ‡è®°

        // å®šä¹‰é™¢æ ¡å±‚çº§
        const SCHOOL_TIERS = {
            '985': [
                'åŒ—äº¬å¤§å­¦', 'æ¸…åå¤§å­¦', 'æµ™æ±Ÿå¤§å­¦', 'å¤æ—¦å¤§å­¦', 'å—äº¬å¤§å­¦', 
                'ä¸­å±±å¤§å­¦', 'æ­¦æ±‰å¤§å­¦', 'åä¸­ç§‘æŠ€å¤§å­¦', 'åŒæµå¤§å­¦', 'ä¸œåŒ—å¤§å­¦',
                'åä¸œå¸ˆèŒƒå¤§å­¦', 'åŒ—äº¬å¸ˆèŒƒå¤§å­¦', 'å…°å·å¤§å­¦'
            ],
            '211': [
                'åŒ—äº¬å¤§å­¦', 'æ¸…åå¤§å­¦', 'æµ™æ±Ÿå¤§å­¦', 'å¤æ—¦å¤§å­¦', 'å—äº¬å¤§å­¦', 
                'ä¸­å±±å¤§å­¦', 'æ­¦æ±‰å¤§å­¦', 'åä¸­ç§‘æŠ€å¤§å­¦', 'åŒæµå¤§å­¦', 'ä¸œåŒ—å¤§å­¦',
                'åä¸œå¸ˆèŒƒå¤§å­¦', 'åŒ—äº¬å¸ˆèŒƒå¤§å­¦', 'ä¸­å›½åœ°è´¨å¤§å­¦(æ­¦æ±‰)', 'ä¸­å›½çŸ¿ä¸šå¤§å­¦',
                'æ²³æµ·å¤§å­¦', 'å—äº¬å¸ˆèŒƒå¤§å­¦', 'ä¸œåŒ—å¸ˆèŒƒå¤§å­¦', 'äº‘å—å¤§å­¦', 'è¥¿åŒ—å¤§å­¦',
                'é™•è¥¿å¸ˆèŒƒå¤§å­¦', 'å…°å·å¤§å­¦', 'åŒ—äº¬æ—ä¸šå¤§å­¦', 'ä¸­å›½åœ°è´¨å¤§å­¦(åŒ—äº¬)',
                'å®å¤å¤§å­¦', 'åˆè‚¥å·¥ä¸šå¤§å­¦', 'åå—å¸ˆèŒƒå¤§å­¦', 'æ–°ç–†å¤§å­¦', 'çŸ³æ²³å­å¤§å­¦',
                'éƒ‘å·å¤§å­¦', 'åä¸­å¸ˆèŒƒå¤§å­¦', 'ç¦å·å¤§å­¦', 'è¥¿å—å¤§å­¦', 'é•¿å®‰å¤§å­¦'
            ]
        };

        // è·å–å­¦æ ¡å±‚çº§
        function getSchoolTier(schoolName) {
            const tiers = [];
            // ç²¾ç¡®åŒ¹é…æ ¡åç§°
            if (SCHOOL_TIERS['985'].includes(schoolName)) {
                tiers.push('985');
            }
            if (SCHOOL_TIERS['211'].includes(schoolName)) {
                tiers.push('211');
            }
            return tiers;
        }

        // ä»JSONæ–‡ä»¶åŠ è½½æ•°æ®
        async function loadData() {
            try {
                const response = await fetch('output/gis_schools.json');
                schools = await response.json();
                console.log('åŠ è½½äº† ' + schools.length + ' æ‰€å­¦æ ¡');
                initMap();
                createSchoolList();
                initSearch();  // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºå­¦æ ¡ä¿¡æ¯
        function showSchoolInfo(school) {
            const infoPanel = document.getElementById('schoolInfo');
            const isFavorite = favorites[school.name];
            
            infoPanel.innerHTML = `
                <div style="padding: 20px; font-size: 14px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <h3 style="margin: 0; color: #2c3e50;">
                            ${school.name}
                            ${getSchoolTier(school.name).map(tier => 
                                `<span style="font-size: 12px; padding: 2px 6px; margin-left: 8px; border-radius: 3px; background-color: ${tier === '985' ? '#e74c3c' : '#3498db'}; color: white;">${tier}</span>`
                            ).join('')}
                        </h3>
                        <button class="favorite-button ${isFavorite ? 'favorited' : ''}" onclick="toggleFavorite('${school.name}')">
                            ${isFavorite ? 'â˜… å·²æ”¶è—' : 'â˜† æ”¶è—'}
                        </button>
                    </div>
                    <p style="margin: 10px 0; color: #666;">${school.province}ï¼Œæ‹›ç”Ÿäººæ•°ï¼š${school.total_students}äºº</p>
                    
                    ${isFavorite ? `
                    <div class="rating-section">
                        <h4 style="margin: 0 0 15px 0; color: #2c3e50;">é™¢æ ¡è¯„åˆ†</h4>
                        <div class="rating-items-container">
                            <div class="rating-item">
                                <label>åœ°ç†ä½ç½®</label>
                                <div class="rating-stars" data-type="location">
                                    ${generateStars(isFavorite.locationRating || 0)}
                                </div>
                            </div>
                            <div class="rating-item">
                                <label>é™¢æ ¡å±‚æ¬¡</label>
                                <div class="rating-stars" data-type="level">
                                    ${generateStars(isFavorite.levelRating || 0)}
                                </div>
                            </div>
                            <div class="rating-item">
                                <label>å½•å–éš¾åº¦</label>
                                <div class="rating-stars" data-type="difficulty">
                                    ${generateStars(isFavorite.difficultyRating || 0)}
                                </div>
                            </div>
                        </div>
                        <div class="rating-item" style="margin-top: 15px;">
                            <textarea style="width: 100%; padding: 8px; margin-top: 5px;" 
                                placeholder="æ·»åŠ å¤‡æ³¨..."
                                onchange="updateNote('${school.name}', this.value)">${isFavorite.note || ''}</textarea>
                        </div>
                    </div>
                    ` : ''}

                    <div style="border-top: 1px solid #eee; padding-top: 10px;">
                        <h4 style="margin: 0 0 8px 0; color: #2c3e50;">æ‹›ç”Ÿä¸“ä¸šä¿¡æ¯ï¼š</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="border: 1px solid #e9ecef; padding: 8px; text-align: left;">é™¢ç³»</th>
                                    <th style="border: 1px solid #e9ecef; padding: 8px; text-align: left;">ä¸“ä¸š</th>
                                    <th style="border: 1px solid #e9ecef; padding: 8px; text-align: left;">ç ”ç©¶æ–¹å‘</th>
                                    <th style="border: 1px solid #e9ecef; padding: 8px; text-align: left;">æ‹›ç”Ÿäººæ•°</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${school.departments.map(dept => `
                                    <tr>
                                        <td style="border: 1px solid #e9ecef; padding: 8px;">${dept.department}</td>
                                        <td style="border: 1px solid #e9ecef; padding: 8px;">${dept.specialty}</td>
                                        <td style="border: 1px solid #e9ecef; padding: 8px;">${dept.field}</td>
                                        <td style="border: 1px solid #e9ecef; padding: 8px;">${dept.number}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <h4 style="margin: 16px 0 8px 0; color: #2c3e50;">è€ƒè¯•ç§‘ç›®ï¼š</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <tbody>
                                ${school.departments.map(dept => `
                                    <tr>
                                        <td colspan="4" style="border: 1px solid #e9ecef; padding: 8px; background-color: #f8f9fa;">
                                            <strong>${dept.department} - ${dept.field}</strong>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #e9ecef; padding: 8px;">${dept.subjects.subject1}</td>
                                        <td style="border: 1px solid #e9ecef; padding: 8px;">${dept.subjects.subject2}</td>
                                        <td style="border: 1px solid #e9ecef; padding: 8px;">${dept.subjects.subject3}</td>
                                        <td style="border: 1px solid #e9ecef; padding: 8px;">${dept.subjects.subject4}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // æ·»åŠ è¯„åˆ†äº‹ä»¶ç›‘å¬
            if (isFavorite) {
                infoPanel.querySelectorAll('.rating-stars').forEach(container => {
                    container.querySelectorAll('.star').forEach((star, index) => {
                        star.addEventListener('click', () => {
                            const type = container.dataset.type;
                            updateRating(school.name, type, index + 1);
                        });
                    });
                });
            }
            
            infoPanel.style.display = 'block';

            // é«˜äº®å¯¹åº”çš„æ ‡è®°
            const markers = map.getAllOverlays('marker');
            if (markers) {
                markers.forEach(marker => {
                    if (marker.getTitle() === school.name) {
                        // å¦‚æœä¹‹å‰æœ‰é«˜äº®çš„æ ‡è®°ï¼Œå…ˆå–æ¶ˆé«˜äº®
                        if (currentHighlightedMarker && currentHighlightedMarker !== marker) {
                            const prevTiers = getSchoolTier(currentHighlightedMarker.getTitle());
                            const prevTier = prevTiers.includes('985') ? '985' : (prevTiers.includes('211') ? '211' : 'normal');
                            updateMarkerState(currentHighlightedMarker, false, prevTier);
                        }
                        // é«˜äº®å½“å‰æ ‡è®°
                        const tiers = getSchoolTier(school.name);
                        const tier = tiers.includes('985') ? '985' : (tiers.includes('211') ? '211' : 'normal');
                        updateMarkerState(marker, true, tier);
                        currentHighlightedMarker = marker;
                    }
                });
            }
        }

        // ç”Ÿæˆæ˜Ÿçº§è¯„åˆ†HTML
        function generateStars(rating) {
            return Array(5).fill(0).map((_, i) => 
                `<span class="star ${i < rating ? 'active' : ''}" data-rating="${i + 1}">â˜…</span>`
            ).join('');
        }

        // åˆ‡æ¢æ”¶è—çŠ¶æ€
        function toggleFavorite(schoolName) {
            if (favorites[schoolName]) {
                delete favorites[schoolName];
            } else {
                favorites[schoolName] = {
                    locationRating: 0,
                    levelRating: 0,
                    difficultyRating: 0,
                    note: ''
                };
            }
            localStorage.setItem('favorites', JSON.stringify(favorites));
            
            // é‡æ–°æ˜¾ç¤ºå­¦æ ¡ä¿¡æ¯
            const school = schools.find(s => s.name === schoolName);
            if (school) {
                showSchoolInfo(school);
            }
            
            // å¦‚æœåœ¨æ”¶è—æ ‡ç­¾ï¼Œåˆ·æ–°è¡¨
            if (document.getElementById('favorites').classList.contains('active')) {
                createSchoolList(true);
            }
        }

        // æ›´æ–°è¯„åˆ†
        function updateRating(schoolName, type, rating) {
            if (favorites[schoolName]) {
                favorites[schoolName][type + 'Rating'] = rating;
                localStorage.setItem('favorites', JSON.stringify(favorites));
                
                // æ›´æ–°æ˜Ÿæ˜Ÿæ˜¾ç¤º
                const stars = document.querySelector(`[data-type="${type}"]`).children;
                Array.from(stars).forEach((star, index) => {
                    star.classList.toggle('active', index < rating);
                });
            }
        }

        // æ›´æ–°å¤‡æ³¨
        function updateNote(schoolName, note) {
            if (favorites[schoolName]) {
                favorites[schoolName].note = note;
                localStorage.setItem('favorites', JSON.stringify(favorites));
            }
        }

        // æ›´æ–°æ ‡è®°çŠ¶æ€
        function updateMarkerState(marker, isHighlighted, tier) {
            if (isHighlighted) {
                marker.setIcon(createHighlightIcon(tier));
                marker.setOffset(new AMap.Pixel(-20, -20));
            } else {
                marker.setIcon(createNormalIcon(tier));
                marker.setOffset(new AMap.Pixel(-16, -16));
            }
        }

        // åˆ›å»ºé«˜äº®å›¾æ ‡
        function createHighlightIcon(tier) {
            const color = tier === '985' ? '#e74c3c' : (tier === '211' ? '#3498db' : '#95a5a6');
            const svg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40">
                    <circle cx="20" cy="20" r="18" fill="${color}" stroke="white" stroke-width="2"/>
                    ${tier !== 'normal' ? `<text x="20" y="25" text-anchor="middle" fill="white" font-size="12">${tier}</text>` : 
                    `<circle cx="20" cy="20" r="6" fill="white"/>`}
                </svg>
            `;
            return new AMap.Icon({
                image: 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg),
                size: new AMap.Size(40, 40),
                imageSize: new AMap.Size(40, 40)
            });
        }

        // åˆ›å»ºæ™®é€šå›¾æ ‡
        function createNormalIcon(tier) {
            const color = tier === '985' ? '#e74c3c' : (tier === '211' ? '#3498db' : '#95a5a6');
            const svg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32">
                    <circle cx="16" cy="16" r="14" fill="${color}" stroke="white" stroke-width="2"/>
                    ${tier !== 'normal' ? `<text x="16" y="20" text-anchor="middle" fill="white" font-size="10">${tier}</text>` : 
                    `<circle cx="16" cy="16" r="5" fill="white"/>`}
                </svg>
            `;
            return new AMap.Icon({
                image: 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg),
                size: new AMap.Size(32, 32),
                imageSize: new AMap.Size(32, 32)
            });
        }

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            map = new AMap.Map('map', {
                zoom: 5,
                center: [104.1954, 35.8616]
            });

            // åˆå§‹åŒ–å«æ˜Ÿå›¾å±‚
            satelliteLayer = new AMap.TileLayer.Satellite();
            
            // åˆå§‹åŒ–çƒ­åŠ›å›¾
            heatmap = new AMap.HeatMap(map, {
                radius: 25,
                opacity: [0, 0.8],
                gradient: {
                    0.2: '#8fce00',  // æµ…ç»¿è‰²
                    0.4: '#4cc417',  // ä¸­ç»¿è‰²
                    0.6: '#ffd700',  // é»„è‰²
                    0.8: '#ff6b6b',  // æµ…çº¢è‰²
                    1.0: '#cc1100'   // æ·±çº¢è‰²
                },
                zIndex: 120
            });

            // å‡†å¤‡çƒ­åŠ›å›¾æ•°æ®
            const heatmapData = schools.map(school => ({
                lng: school.location.longitude,
                lat: school.location.latitude,
                count: parseInt(school.total_students) || 1
            })).filter(data => data.count > 0);

            heatmap.setDataSet({
                data: heatmapData,
                max: Math.max(...heatmapData.map(d => d.count))
            });
            heatmap.hide();

            // æ·»åŠ æ§ä»¶äº‹ä»¶ç›‘å¬
            document.getElementById('zoomIn').addEventListener('click', () => {
                map.setZoom(map.getZoom() + 1);
            });

            document.getElementById('zoomOut').addEventListener('click', () => {
                map.setZoom(map.getZoom() - 1);
            });

            document.getElementById('zoomFit').addEventListener('click', () => {
                map.setZoomAndCenter(5, [104.1954, 35.8616]);
            });

            // å«æ˜Ÿå›¾åˆ‡æ¢
            document.getElementById('satelliteToggle').addEventListener('click', () => {
                const button = document.getElementById('satelliteToggle');
                if (isSatelliteVisible) {
                    satelliteLayer.setMap(null);
                    button.classList.remove('active');
                } else {
                    satelliteLayer.setMap(map);
                    button.classList.add('active');
                }
                isSatelliteVisible = !isSatelliteVisible;
            });

            // çƒ­åŠ›å›¾åˆ‡æ¢
            document.getElementById('heatmapToggle').addEventListener('click', () => {
                const button = document.getElementById('heatmapToggle');
                if (isHeatmapVisible) {
                    heatmap.hide();
                    button.classList.remove('active');
                    // æ¢å¤æ‰€æœ‰æ ‡è®°çš„æ˜¾ç¤º
                    const markers = map.getAllOverlays('marker');
                    if (markers) {
                        markers.forEach(marker => {
                            marker.show();
                        });
                    }
                } else {
                    // éšè—æ‰€æœ‰æ ‡è®°
                    const markers = map.getAllOverlays('marker');
                    if (markers) {
                        markers.forEach(marker => {
                            marker.hide();
                        });
                    }
                    // æ˜¾ç¤ºçƒ­åŠ›å›¾
                    heatmap.show();
                    button.classList.add('active');
                }
                isHeatmapVisible = !isHeatmapVisible;
            });

            // æ·»åŠ æ ‡è®°
            schools.forEach(school => {
                if (school.location && school.location.longitude && school.location.latitude) {
                    const tiers = getSchoolTier(school.name);
                    let tier = tiers.includes('985') ? '985' : (tiers.includes('211') ? '211' : 'normal');
                    
                    let marker = new AMap.Marker({
                        map: map,
                        position: [school.location.longitude, school.location.latitude],
                        title: school.name,
                        icon: createNormalIcon(tier),
                        offset: new AMap.Pixel(-16, -16),
                        clickable: true
                    });

                    // å•å‡»æ˜¾ç¤ºä¿¡æ¯
                    marker.on('click', () => {
                        showSchoolInfo(school);
                        document.getElementById('schoolInfo').style.display = 'block';
                    });

                    // åŒå‡»ç¼©æ”¾åˆ°å­¦æ ¡ä½ç½®
                    marker.on('dblclick', () => {
                        // è®¡ç®—åç§»åçš„ä¸­å¿ƒç‚¹ï¼Œå‘å·¦åç§»ä»¥é¿å…è¢«ä¿¡æ¯æ¡†é®æŒ¡
                        const offset = -0.025;  // ç»åº¦åç§»é‡
                        map.setZoomAndCenter(14, [school.location.longitude + offset, school.location.latitude]);
                    });
                }
            });

            // ç‚¹å‡»åœ°å›¾ç™½å¤„å…³é—­ä¿¡æ¯é¢æ¿
            map.on('click', (e) => {
                const target = e.target;
                // åªæœ‰åœ¨ç‚¹å‡»åœ°å›¾æœ¬èº«ï¼Œè€Œä¸æ˜¯æ ‡è®°æ—¶æ‰å…³é—­ä¿¡æ¯é¢æ¿
                if (target instanceof AMap.Map) {
                    document.getElementById('schoolInfo').style.display = 'none';
                    // å–æ¶ˆå½“å‰æ ‡è®°çš„é«˜äº®
                    if (currentHighlightedMarker) {
                        const tiers = getSchoolTier(currentHighlightedMarker.getTitle());
                        const tier = tiers.includes('985') ? '985' : (tiers.includes('211') ? '211' : 'normal');
                        updateMarkerState(currentHighlightedMarker, false, tier);
                        currentHighlightedMarker = null;
                    }
                }
            });
        }

        // ä¿®æ”¹createSchoolListå‡½æ•°ä»¥æ”¯æŒä¸åŒçš„è§†å›¾æ¨¡å¼
        function createSchoolList(showFavorites = false) {
            const schoolList = document.getElementById('schoolList');
            schoolList.innerHTML = '';
            
            let filteredSchools = showFavorites 
                ? schools.filter(school => favorites[school.name])
                : schools;

            if (currentView === 'province') {
                createProvinceView(filteredSchools);
            } else {
                createTierView(filteredSchools);
            }
        }

        // æŒ‰çœä»½è§†å›¾
        function createProvinceView(filteredSchools) {
            const schoolsByProvince = filteredSchools.reduce((acc, school) => {
                const province = school.province || 'å…¶ä»–';
                if (!acc[province]) acc[province] = [];
                acc[province].push(school);
                return acc;
            }, {});

            const sortedProvinces = Object.keys(schoolsByProvince).sort();
            
            sortedProvinces.forEach(province => {
                const provinceDiv = document.createElement('div');
                provinceDiv.className = 'province-group';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'province-header';
                headerDiv.innerHTML = `
                    <span>${province}</span>
                    <span class="arrow">â–¼</span>
                `;
                
                const schoolsDiv = document.createElement('div');
                schoolsDiv.className = 'province-schools';
                
                schoolsByProvince[province].forEach(school => {
                    const schoolDiv = createSchoolItem(school);
                    schoolsDiv.appendChild(schoolDiv);
                });
                
                headerDiv.addEventListener('click', () => {
                    headerDiv.classList.toggle('active');
                    schoolsDiv.classList.toggle('active');
                });
                
                provinceDiv.appendChild(headerDiv);
                provinceDiv.appendChild(schoolsDiv);
                schoolList.appendChild(provinceDiv);
            });
        }

        // æŒ‰å±‚çº§è§†å›¾
        function createTierView(filteredSchools) {
            const schoolsByTier = {
                '985': [],
                '211': [],
                'æ™®é€šé™¢æ ¡': []
            };

            filteredSchools.forEach(school => {
                const tiers = getSchoolTier(school.name);
                if (tiers.length === 0) {
                    schoolsByTier['æ™®é€šé™¢æ ¡'].push(school);
                } else {
                    // å°†å­¦æ ¡æ·»åŠ åˆ°å…¶æœ€é«˜å±‚çº§
                    if (tiers.includes('985')) {
                        schoolsByTier['985'].push(school);
                    } else if (tiers.includes('211')) {
                        schoolsByTier['211'].push(school);
                    }
                }
            });

            const tiers = ['985', '211', 'æ™®é€šé™¢æ ¡'];
            
            tiers.forEach(tier => {
                if (schoolsByTier[tier].length === 0) return;

                const tierDiv = document.createElement('div');
                tierDiv.className = 'tier-group';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'tier-header';
                headerDiv.innerHTML = `
                    <span>${tier}ï¼ˆ${schoolsByTier[tier].length}æ‰€ï¼‰</span>
                    <span class="arrow">â–¼</span>
                `;
                
                const schoolsDiv = document.createElement('div');
                schoolsDiv.className = 'tier-schools';
                
                schoolsByTier[tier].sort((a, b) => a.name.localeCompare(b.name)).forEach(school => {
                    const schoolDiv = createSchoolItem(school);
                    schoolsDiv.appendChild(schoolDiv);
                });
                
                headerDiv.addEventListener('click', () => {
                    headerDiv.classList.toggle('active');
                    schoolsDiv.classList.toggle('active');
                });
                
                tierDiv.appendChild(headerDiv);
                tierDiv.appendChild(schoolsDiv);
                schoolList.appendChild(tierDiv);
            });
        }

        // åˆ›å»ºå­¦æ ¡åˆ—è¡¨é¡¹
        function createSchoolItem(school) {
            const schoolDiv = document.createElement('div');
            schoolDiv.className = 'school-item';
            const tiers = getSchoolTier(school.name);
            const tierLabels = tiers.length > 0 
                ? `<small style="color: #4a89dc;">[${tiers.join('/')}]</small>` 
                : '';
            
            schoolDiv.innerHTML = `
                <div>${school.name} ${tierLabels}</div>
                <small>æ‹›ç”Ÿäººæ•°ï¼š${school.total_students || 'æœªçŸ¥'}äºº</small>
            `;
            
            // å•å‡»æ—¶ç¼©æ”¾åˆ°å­¦æ ¡ä½ç½®å¹¶æ˜¾ç¤ºä¿¡æ¯
            schoolDiv.addEventListener('click', () => {
                if (school.location && school.location.longitude && school.location.latitude) {
                    // è®¡ç®—åç§»åçš„ä¸­å¿ƒç‚¹ï¼Œå‘å·¦åç§»ä»¥é¿å…è¢«ä¿¡æ¯æ¡†é®æŒ¡
                    const offset = -0.025;  // ç»åº¦åç§»é‡
                    map.setZoomAndCenter(14, [school.location.longitude + offset, school.location.latitude]);
                    showSchoolInfo(school);
                    document.getElementById('schoolInfo').style.display = 'block';
                }
            });
            
            return schoolDiv;
        }

        // æœåŠŸèƒ½
        function initSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchClear = document.getElementById('searchClear');
            
            // å¤„ç†æœç´¢
            function handleSearch() {
                const searchText = searchInput.value.toLowerCase();
                const showFavorites = document.getElementById('favorites').classList.contains('active');
                const filteredSchools = showFavorites 
                    ? schools.filter(school => favorites[school.name])
                    : schools;

                if (currentView === 'province') {
                    // å¤„ç†æŒ‰çœä»½è§†å›¾çš„æœç´¢
                    document.querySelectorAll('.province-group').forEach(group => {
                        const schoolDivs = group.querySelectorAll('.school-item');
                        let hasVisibleSchools = false;
                        
                        schoolDivs.forEach(div => {
                            const schoolName = div.querySelector('div').textContent.toLowerCase();
                            const isVisible = schoolName.includes(searchText);
                            div.style.display = isVisible ? 'block' : 'none';
                            if (isVisible) hasVisibleSchools = true;
                        });
                        
                        group.style.display = hasVisibleSchools ? 'block' : 'none';
                        
                        // å¦‚æœæœ‰æœç´¢æ–‡æœ¬ï¼Œå±•å¼€åŒ…å«åŒ¹é…å­¦æ ¡çš„çœä»½
                        if (searchText && hasVisibleSchools) {
                            const schoolsDiv = group.querySelector('.province-schools');
                            const header = group.querySelector('.province-header');
                            schoolsDiv.classList.add('active');
                            header.classList.add('active');
                        }
                    });
                } else {
                    // å¤„ç†æŒ‰å±‚çº§è§†å›¾çš„æœç´¢
                    document.querySelectorAll('.tier-group').forEach(group => {
                        const schoolDivs = group.querySelectorAll('.school-item');
                        let hasVisibleSchools = false;
                        
                        schoolDivs.forEach(div => {
                            const schoolName = div.querySelector('div').textContent.toLowerCase();
                            const isVisible = schoolName.includes(searchText);
                            div.style.display = isVisible ? 'block' : 'none';
                            if (isVisible) hasVisibleSchools = true;
                        });
                        
                        group.style.display = hasVisibleSchools ? 'block' : 'none';
                        
                        // å¦‚æœæœ‰æœç´¢æ–‡æœ¬ï¼Œå±•å¼€åŒ…å«åŒ¹é…å­¦æ ¡çš„å±‚çº§
                        if (searchText && hasVisibleSchools) {
                            const schoolsDiv = group.querySelector('.tier-schools');
                            const header = group.querySelector('.tier-header');
                            schoolsDiv.classList.add('active');
                            header.classList.add('active');
                        }
                    });
                }
            }

            // æ¸…é™¤æœç´¢
            function clearSearch() {
                searchInput.value = '';
                searchInput.focus();
                
                // é‡ç½®æ‰€æœ‰åˆ†ç»„çš„æ˜¾ç¤ºçŠ¶æ€
                if (currentView === 'province') {
                    document.querySelectorAll('.province-group').forEach(group => {
                        group.style.display = 'block';
                        const schoolsDiv = group.querySelector('.province-schools');
                        const header = group.querySelector('.province-header');
                        schoolsDiv.classList.remove('active');
                        header.classList.remove('active');
                    });
                } else {
                    document.querySelectorAll('.tier-group').forEach(group => {
                        group.style.display = 'block';
                        const schoolsDiv = group.querySelector('.tier-schools');
                        const header = group.querySelector('.tier-header');
                        schoolsDiv.classList.remove('active');
                        header.classList.remove('active');
                    });
                }
                
                // é‡ç½®æ‰€æœ‰å­¦æ ¡é¡¹çš„æ˜¾ç¤ºçŠ¶æ€
                document.querySelectorAll('.school-item').forEach(div => {
                    div.style.display = 'block';
                });
            }

            // äº‹ä»¶ç›‘å¬
            searchInput.addEventListener('input', handleSearch);
            searchClear.addEventListener('click', clearSearch);
            
            // æ·»åŠ å¿«æ·é”®æ”¯æŒ
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    clearSearch();
                }
            });
        }

        // æ·»åŠ æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
        document.getElementById('allSchools').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('favorites').classList.remove('active');
            document.getElementById('clearFavorites').style.display = 'none';
            createSchoolList(false);
        });

        document.getElementById('favorites').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('allSchools').classList.remove('active');
            document.getElementById('clearFavorites').style.display = 'inline-block';
            createSchoolList(true);
        });

        // æ·»åŠ å›¾åˆ‡æ¢åŠŸèƒ½
        document.getElementById('viewByProvince').addEventListener('click', function() {
            if (currentView === 'province') return;
            this.classList.add('active');
            document.getElementById('viewByTier').classList.remove('active');
            currentView = 'province';
            createSchoolList(document.getElementById('favorites').classList.contains('active'));
        });

        document.getElementById('viewByTier').addEventListener('click', function() {
            if (currentView === 'tier') return;
            this.classList.add('active');
            document.getElementById('viewByProvince').classList.remove('active');
            currentView = 'tier';
            createSchoolList(document.getElementById('favorites').classList.contains('active'));
        });

        // æ·»åŠ æ¸…ç©ºæ”¶è—åŠŸèƒ½
        document.getElementById('clearFavorites').addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ”¶è—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                // æ¸…ç©ºæ”¶è—æ•°æ®
                favorites = {};
                localStorage.setItem('favorites', JSON.stringify(favorites));
                
                // å¦‚æœå½“å‰åœ¨æ”¶è—é¡µé¢ï¼Œåˆ·æ–°åˆ—è¡¨
                if (document.getElementById('favorites').classList.contains('active')) {
                    createSchoolList(true);
                }
                
                // å¦‚æœä¿¡æ¯é¢æ¿æ­£åœ¨æ˜¾ç¤ºï¼Œå…³é—­å®ƒ
                document.getElementById('schoolInfo').style.display = 'none';
                
                // å–æ¶ˆå½“å‰æ ‡è®°çš„é«˜äº®
                if (currentHighlightedMarker) {
                    const tiers = getSchoolTier(currentHighlightedMarker.getTitle());
                    const tier = tiers.includes('985') ? '985' : (tiers.includes('211') ? '211' : 'normal');
                    updateMarkerState(currentHighlightedMarker, false, tier);
                    currentHighlightedMarker = null;
                }
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html> 